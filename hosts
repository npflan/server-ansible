#!/bin/bash

# Get script location for explicit reference
BASEDIR=$(dirname "$0")

if [ "$1" = '--host' ]; then
  echo "{}"
  exit 0
fi

addresses=$(dig srv ansible.srv.minserver.dk +nocmd +noall +answer @10.101.128.128|cut -d" " -f5|grep -v "ip-101-74\|minecraft\|repo1\|repo2\|repo3"|sort|sed 's/\.$//'|sed 's/<<>>//'|grep -Ev "^$")

output="{\n"
output="${output} `cat ${BASEDIR}/hostfiles/hosts_*`\n"
output="${output}  \"npf_gameservers\": [\n"

while read -r address; do
  output="${output}    \"${address}\",\n"
done <<< "$addresses"

output="${output} ],"

addresses=$(dig srv ansible.srv.minserver.dk +nocmd +noall +answer @10.101.128.128|cut -d" " -f5|sort|sed 's/\.$//'|sed 's/<<>>//'|grep -Ev "^$")

output="${output}  \"npf_gameservers_all\": [\n"

while read -r address; do
  output="${output}    \"${address}\",\n"
done <<< "$addresses"

output="${output} ],"

output="${output}\n  \"npf_gameservers-current-rack\": [\n"

# Information om nucÃ¦rende rack
rack=$(ip -f inet address | grep 10.100 | cut -d. -f 3|sed 's/^10//')
rackServers=$(printf -- "%s\n" "${addresses[@]}" | grep "rack$rack")


while read -r address; do
  output="${output}    \"${address}\",\n"
done <<< "$rackServers"

output="${output} ]\n}"


#echo -e `echo $output | sed 's/\(.*\),/\1/'`
echo -e $output
